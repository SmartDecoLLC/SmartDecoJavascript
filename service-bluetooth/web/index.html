<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="SmartDeco Bluetooth Setup">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartDeco Bluetooth Setup</title>
    <script>
      // Add a global error event listener early on in the page load, to help ensure that browsers
      // which don't support specific functionality still end up displaying a meaningful message.
      window.addEventListener('error', function(error) {
        console.error(error)
      })
    </script>
  </head>

  <body>

<form>
  <button id="startNotifications">Start</button>
  <button id="stopNotifications" style="display:''">Stop</button>
</form>

<ul id="aps"></ul>

<script>
  // key is ap name, value is not used
  var aps = {}
  var serviceUuid = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'
  var listCharacteristicUuid = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'
  var statusUuid = '6e400002-b5a3-f393-e0a9-e50e24dcca9f'
  var setSSIDCharacteristicUuid = '6e400002-b5a3-f393-e0a9-e50e24dcca80'
  var setPasswordCharacteristicUuid = '6e400002-b5a3-f393-e0a9-e50e24dcca81'

  var listCharacteristic, setSSIDCharacteristic, setPasswordCharacteristic, statusCharacteristic

  async function onStartButtonClick() {
    try {
      console.log('Requesting Bluetooth Device...')
      const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [ serviceUuid ] }]})

      console.log('Connecting to GATT Server...')
      const server = await device.gatt.connect()

      console.log('Getting Service...')
      const service = await server.getPrimaryService(serviceUuid)

      console.log('Getting Characteristics...')
      listCharacteristic = await service.getCharacteristic(listCharacteristicUuid)
      setSSIDCharacteristic = await service.getCharacteristic(setSSIDCharacteristicUuid)
      setPasswordCharacteristic = await service.getCharacteristic(setPasswordCharacteristicUuid)
      statusCharacteristic = await service.getCharacteristic(statusUuid)

      await listCharacteristic.startNotifications()
      await statusCharacteristic.startNotifications()

      console.log('> Notifications started')
      listCharacteristic.addEventListener('characteristicvaluechanged',
          handleNotifications)
      statusCharacteristic.addEventListener('characteristicvaluechanged',
          handleStatusNotifications)
    } catch(error) {
      console.log('Argh! ' + error)
    }
  }

  async function onStopButtonClick() {
    if (listCharacteristic) {
      try {
        await listCharacteristic.stopNotifications()
        await statusCharacteristic.stopNotifications()
        console.log('> Notifications stopped')
        listCharacteristic.removeEventListener('characteristicvaluechanged',
            handleNotifications)
        statusCharacteristic.removeEventListener('characteristicvaluechanged',
            handleStatusNotifications)
      } catch(error) {
        console.log('Argh! ' + error)
      }
    }
  }

  function renderAPList(aps) {
    var el = document.getElementById('aps')
    //el.innerHTML = ''

    Object.keys(aps).forEach(function(ap) {
      // if the ap already exists in the list don't re-add it
      if(document.getElementById('ap-'+ap))
        return
      var d = document.createElement('li')
      d.id = 'ap-' + ap
      d.innerText = ap
      d.style.cursor = 'pointer'
      d.onclick = function(ev) {
        var pwd = prompt('please enter the password for ' + this.innerText + ':')
        var enc = new TextEncoder('utf-8')
        setSSIDCharacteristic.writeValue(enc.encode(this.innerText))
        setPasswordCharacteristic.writeValue(enc.encode(pwd))
        // TODO: set ui to connecting mode
      }
      el.appendChild(d)
    })
  }

  function handleNotifications(event) {
    var dec = new TextDecoder('utf-8')
    var k = dec.decode(event.target.value)
    aps[k] = true
    renderAPList(aps)
  }

  function handleStatusNotifications(event) {
    var dec = new TextDecoder('utf-8')
    var newStatus = dec.decode(event.target.value)
    console.log('TODO: deal with new status:', newStatus)
  }

  document.querySelector('#startNotifications').addEventListener('click', function(event) {
    event.stopPropagation()
    event.preventDefault()

    if (isWebBluetoothEnabled()) {
      console.clear()
      onStartButtonClick()
    }
  })

  document.querySelector('#stopNotifications').addEventListener('click', function(event) {
    event.stopPropagation()
    event.preventDefault()

    if (isWebBluetoothEnabled()) {
      onStopButtonClick()
    }
  })

  function isWebBluetoothEnabled() {
    if (navigator.bluetooth) {
      return true
    } else {
      ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
          'Please make sure the "Experimental Web Platform features" flag is enabled.')
      return false
    }
  }
</script>

  </body>
</html>
