<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="SmartDeco Bluetooth Setup">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartDeco Bluetooth Setup</title>
    <script>
      // Add a global error event listener early on in the page load, to help ensure that browsers
      // which don't support specific functionality still end up displaying a meaningful message.
      window.addEventListener('error', function(error) {
        console.error(error)
      })
    </script>
  </head>

  <body>

<form>
  <input id="service" type="text" value="6e400001-b5a3-f393-e0a9-e50e24dcca9e" autofocus placeholder="Bluetooth Service">
  <input id="characteristic" type="text" value="6e400002-b5a3-f393-e0a9-e50e24dcca9e" placeholder="Bluetooth Characteristic">
  <button id="startNotifications">Start notifications</button>
  <button id="stopNotifications">Stop notifications</button>
</form>

<h3>Access Points</h3>
<ul id="aps"></ul>


<script>
// key is ap name, value is not used
var aps = {}

var myCharacteristic;

async function onStartButtonClick() {
  let serviceUuid = document.querySelector('#service').value;
  if (serviceUuid.startsWith('0x')) {
    serviceUuid = parseInt(serviceUuid);
  }

  let characteristicUuid = document.querySelector('#characteristic').value;
  if (characteristicUuid.startsWith('0x')) {
    characteristicUuid = parseInt(characteristicUuid);
  }

  try {
    console.log('Requesting Bluetooth Device...');
    const device = await navigator.bluetooth.requestDevice({
        filters: [{services: [serviceUuid]}]});

    console.log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    console.log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    console.log('Getting Characteristic...');
    myCharacteristic = await service.getCharacteristic(characteristicUuid);

    await myCharacteristic.startNotifications()

    console.log('> Notifications started')
    myCharacteristic.addEventListener('characteristicvaluechanged',
        handleNotifications);
  } catch(error) {
    console.log('Argh! ' + error)
  }
}

async function onStopButtonClick() {
  if (myCharacteristic) {
    try {
      await myCharacteristic.stopNotifications()
      console.log('> Notifications stopped')
      myCharacteristic.removeEventListener('characteristicvaluechanged',
          handleNotifications);
    } catch(error) {
      console.log('Argh! ' + error)
    }
  }
}

function renderAPList(aps) {
  var el = document.getElementById('aps')
  //el.innerHTML = ''

  Object.keys(aps).forEach(function(ap) {
    // if the ap already exists in the list don't re-add it
    if(document.getElementById('ap-'+ap))
      return
    var d = document.createElement('li')
    d.id = 'ap-' + ap
    d.innerText = ap
    d.style.cursor = 'pointer'
    d.onclick = function(ev) {
      var pwd = prompt('please enter the password for ' + this.innerText + ':')
      //alert('password: ' + pwd)
      // TODO: write AP name & password to characteristics
    }
    el.appendChild(d)
  })
}

function handleNotifications(event) {
  let value = event.target.value
  let a = []
  // Convert raw data bytes to hex values just for the sake of showing something.
  // In the "real" world, you'd use data.getUint8, data.getUint16 or even
  // TextDecoder to process raw data bytes.
  for (let i = 0; i < value.byteLength; i++) {
    //a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
    a.push(String.fromCharCode(value.getUint8(i)))
  }
  aps[a.join('')] = true
  renderAPList(aps)
  //console.log('> ' + a.join(''));
}

  document.querySelector('#startNotifications').addEventListener('click', function(event) {
    event.stopPropagation()
    event.preventDefault()

    if (isWebBluetoothEnabled()) {
      console.clear()
      onStartButtonClick()
    }
  });
  document.querySelector('#stopNotifications').addEventListener('click', function(event) {
    event.stopPropagation()
    event.preventDefault()

    if (isWebBluetoothEnabled()) {
      onStopButtonClick()
    }
  });

  function isWebBluetoothEnabled() {
    if (navigator.bluetooth) {
      return true
    } else {
      ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
          'Please make sure the "Experimental Web Platform features" flag is enabled.');
      return false
    }
  }
</script>


  </body>
</html>
